const stages_data = {
  "stage-01": {
    "name": "Etapa 1",
    "date": "2024-08-17T16:23:00+0100",
    "location": "Lisboa to Oeiros (PT)",
    "distance": 12.005205927832941,
    "up": 49.0,
    "down": -38.0,
    "type": "Individual Time Trial"
  },
  "stage-02": {
    "name": "Etapa 2",
    "date": "2024-08-18T11:50:00+0100",
    "location": "Cascais to Our\u00e9m (PT)",
    "distance": 191.33669319839984,
    "up": 2682.0,
    "down": -2528.0,
    "type": "Lumpy"
  },
  "stage-03": {
    "name": "Etapa 3",
    "date": "2024-08-19T11:50:00+0100",
    "location": "Lous\u00e3 to Castelo Branco (PT)",
    "distance": 191.28872646799744,
    "up": 2666.0,
    "down": -2465.0,
    "type": "Hilly"
  },
  "stage-04": {
    "name": "Etapa 4",
    "date": "2024-08-20T13:05:00+0200",
    "location": "Plasencia to Pico Villuercas",
    "distance": 166.4283999452081,
    "up": 3520.0,
    "down": -2265.0,
    "type": "Mountain"
  },
  "stage-05": {
    "name": "Etapa 5",
    "date": "2024-08-21T13:25:00+0200",
    "location": "Fuente del Maestre to Sevilla",
    "distance": 169.36354451515356,
    "up": 1684.0,
    "down": -2076.0,
    "type": "Lumpy"
  },
  "stage-06": {
    "name": "Etapa 6",
    "date": "2024-08-22T12:40:00+0200",
    "location": "Carrefour Jerez to Yunquera",
    "distance": 180.88025755371712,
    "up": 3672.0,
    "down": -2967.0,
    "type": "Hilly"
  },
  "stage-07": {
    "name": "Etapa 7",
    "date": "2024-08-23T13:10:00+0200",
    "location": "Archidona to C\u00f3rdoba",
    "distance": 179.24556418399627,
    "up": 1920.0,
    "down": -2304.0,
    "type": "Hilly"
  },
  "stage-08": {
    "name": "Etapa 8",
    "date": "2024-08-24T13:30:00+0200",
    "location": "\u00dabeda to Cazorla",
    "distance": 159.15494065802736,
    "up": 2660.0,
    "down": -2348.0,
    "type": "Hilly"
  },
  "stage-09": {
    "name": "Etapa 9",
    "date": "2024-08-25T12:35:00+0200",
    "location": "Motril to Granada",
    "distance": 177.9802176216144,
    "up": 4425.0,
    "down": -3996.0,
    "type": "Mountain"
  },
  "rest-01": {
    "name": "Rest day 1",
    "date": "2024-08-26T12:00:00+0200",
    "location": "Vigo"
  },
  "stage-10": {
    "name": "Etapa 10",
    "date": "2024-08-27T13:30:00+0200",
    "location": "Ponteareas to Baiona",
    "distance": 158.76605960256492,
    "up": 2950.0,
    "down": -3017.0,
    "type": "Medium Mountain"
  },
  "stage-11": {
    "name": "Etapa 11",
    "date": "2024-08-28T13:30:00+0200",
    "location": " Campus Tecnol\u00f3gico Cortizo. Padr\u00f3n",
    "distance": 162.62967594114738,
    "up": 2714.0,
    "down": -2705.0,
    "type": "Medium Mountain"
  },
  "stage-12": {
    "name": "Etapa 12",
    "date": "2024-08-29T14:10:00+0200",
    "location": " Ourense Termal to Estaci\u00f3n de Monta\u00f1a de Manzaneda",
    "distance": 130.60774653884263,
    "up": 3020.0,
    "down": -1744.0,
    "type": "Medium Mountain"
  },
  "stage-13": {
    "name": "Etapa 13",
    "date": "2024-08-30T12:55:00+0200",
    "location": "Lugo to Puerto de Ancares",
    "distance": 170.8627552005816,
    "up": 3409.0,
    "down": -2212.0,
    "type": "Mountain"
  },
  "stage-14": {
    "name": "Etapa 14",
    "date": "2024-08-31T12:25:00+0200",
    "location": "Villafranca del Bierzo to Villablino",
    "distance": 198.76981640450165,
    "up": 2830.0,
    "down": -2287.0,
    "type": "Mountain"
  },
  "stage-15": {
    "name": "Etapa 15",
    "date": "2024-09-01T13:50:00+0200",
    "location": " Infiesto to Valgrande-Pajares. Cuitu Negru",
    "distance": 140.53960510690368,
    "up": 3733.0,
    "down": -2082.0,
    "type": "Mountain"
  },
  "rest-02": {
    "name": "Rest day 2",
    "date": "2024-09-02T12:00:00+0200",
    "location": "Oviedo"
  },
  "stage-16": {
    "name": "Etapa 16",
    "date": "2024-09-03T12:50:00+0200",
    "location": "Luanco to Lagos de Covadonga",
    "distance": 180.38143684088573,
    "up": 3992.0,
    "down": -2980.0,
    "type": "Mountain"
  },
  "stage-17": {
    "name": "Etapa 17",
    "date": "2024-09-04T14:10:00+0200",
    "location": "Monumento Juan de Castillo. Arnuero to Santander",
    "distance": 141.04871442328556,
    "up": 2649.13,
    "down": -2680.13,
    "type": "Hilly"
  },
  "stage-18": {
    "name": "Etapa 18",
    "date": "2024-09-05T13:05:00+0200",
    "location": "Vitoria-Gasteiz to Maeztu-Parque Natural de Izki",
    "distance": 169.59252335020517,
    "up": 2711.0,
    "down": -2551.0,
    "type": "Hilly"
  },
  "stage-19": {
    "name": "Etapa 19",
    "date": "2024-09-06T13:15:00+0200",
    "location": "Logro\u00f1o to Alto de Moncalvillo",
    "distance": 167.93166444625336,
    "up": 2528.0,
    "down": -1493.0,
    "type": "Hilly"
  },
  "stage-20": {
    "name": "Etapa 20",
    "date": "2024-09-07T13:00:00+0200",
    "location": "Villarcayo to Pic\u00f3n Blanco",
    "distance": 171.03370796019212,
    "up": 5063.72,
    "down": -4174.72,
    "type": "Mountain"
  },
  "stage-21": {
    "name": "Etapa 21",
    "date": "2024-09-08T16:20:00+0200",
    "location": "Distrito Telef\u00f3nica. Madrid to Madrid",
    "distance": 23.38111976944917,
    "up": 184.0,
    "down": -234.0,
    "type": "Individual Time Trial"
  }
};

const currentTime = new Date();
const tzInfoParagraph = document.getElementById("tz-info");
tzInfoParagraph.textContent += `${currentTime
  .toLocaleTimeString("en-GB", {
    hour: "numeric",
    minute: "numeric",
    timeZoneName: "long",
  })
  .slice(5)}`;

Object.keys(stages_data).forEach((stageKey) => {
  const topElems = document.createElement("div");
  topElems.className = "top-elements";
  const bottomElems = document.createElement("div");
  bottomElems.className = "bottom-elements";

  const stageInfo = stages_data[stageKey];
  const stageDiv = document.getElementById(stageKey);
  const stageInfoDiv = document.createElement("div");
  stageInfoDiv.className = "stage-info";

  const profileDiv = document.createElement("div");
  profileDiv.className = "profile";
  profileDiv.dataset.stage = `${stageKey}`;

  const eta = document.createElement("p");
  eta.className = "eta";
  const stageStart = new Date(stageInfo.date);
  let etaValue = stageStart.getTime();
  const distance = stageInfo.distance;
  const elevation = stageInfo.up;

  if (stageKey === "stage-01") {
    etaValue += (187 * 60 * 1000);
  } else if (stageKey === "stage-21") {
    etaValue += (190 * 60 * 1000);
  } else {
    etaValue += 75654.7750 * distance + 720.2032 * elevation + -138987.3812;
  };
  let stageFinish = new Date(etaValue);
  eta.textContent = `${stageFinish.toLocaleTimeString("en-GB", {
    hour: "numeric",
    minute: "numeric",
  })}`;
  const tz_text = document.createElement("span");
  tz_text.className = "tz";
  tz_text.textContent += `${stageFinish
    .toLocaleTimeString("en-GB", {
      hour: "numeric",
      minute: "numeric",
      timeZoneName: "short",
    })
    .slice(5)}`;
  eta.appendChild(tz_text);

  const stageHeader = document.createElement("h2");
  stageHeader.textContent = stages_data[stageKey].name;
  stageHeader.textContent += ` : ${stageStart
    .toLocaleDateString("en-GB", {
      weekday: "short",
      month: "short",
      day: "numeric",
      hour: "numeric",
      minute: "numeric",
    })
    .replace(",", "")}`;
  const stageStartTz = document.createElement("span");
  stageStartTz.className = "tz";
  stageStartTz.textContent = `${stageStart
    .toLocaleTimeString("en-GB", {
      hour: "numeric",
      minute: "numeric",
      timeZoneName: "short",
    })
    .slice(5)}`;
  if (stageKey === "rest-01" || stageKey === "rest-02") {
    stageStartTz.textContent = "";
    stageHeader.textContent = stageHeader.textContent.slice(0, -7);
    stageFinish = new Date(stageStart.getTime() + (12 * 60 * 60 * 1000));
  };
  stageHeader.appendChild(stageStartTz);
  topElems.appendChild(stageHeader);
  if (currentTime.getTime() > stageFinish.getTime() + (60 * 60 * 1000)) {
    stageDiv.classList.add("done");
  };

  Object.keys(stageInfo).forEach((key) => {
    if (!["name", "date", "finish"].includes(key)) {
      const p = document.createElement("p");
      p.className = `${key}`;
      if (key === "location") {
        p.innerHTML = `${stageInfo[key]}`;
        topElems.appendChild(p);
      } else if (key == "distance") {
        p.textContent = `${stageInfo[key].toFixed(1)}`;
        topElems.appendChild(p);
      } else if (["down", "up"].includes(key)) {
        p.textContent = `${Math.abs(stageInfo[key].toFixed(0))}`;
        stageInfoDiv.appendChild(p);
      } else if (key === "type") {
        p.dataset.type = `${stageInfo[key].toLowerCase().replaceAll(" ", "-")}`;
        p.textContent = `${stageInfo[key]}`;
        topElems.appendChild(p);
      } else {
        p.textContent = `${stageInfo[key]}`;
        stageInfoDiv.appendChild(p);
      }
      if (!["rest-01", "rest-02"].includes(stageKey)) {
        bottomElems.appendChild(profileDiv);
        stageInfoDiv.appendChild(eta);
      }

      bottomElems.appendChild(stageInfoDiv);
      stageDiv.appendChild(topElems);
      stageDiv.appendChild(bottomElems);
    }
  });
});
